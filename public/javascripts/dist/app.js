var MunchiesMapView=function(e){var t=this;this.map=null,this.markerDelegate=null,this.lastRequestTime=0,this.nearbyTruckQueue=[],this.pendingUrls=[],this.zoomLevel=e.zoomLevel||16,this.n=e.n||10,this.dist=e.dist||.02,this.lastCoords=e.lastCoords||null,this.center={pinned:!1},this.dragDelegate=new MunchiesMapDragDelegate,this.mapPlaceholder=document.getElementById("mapPlaceholder"),this.truckList=document.getElementById("truckList"),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(n){var i=n.coords.latitude,o=n.coords.longitude;t.lastCoords=new google.maps.LatLng(i,o),t.renderMap({zoom:t.zoomLevel,center:t.lastCoords,mapTypeControl:!0,mapTypeId:google.maps.MapTypeId.ROADMAP,bounceDuration:1400},e.centerPinPath)}):alert("Geolocation API not supported.")};MunchiesMapView.prototype.displayNewTrucks=function(e){var t,n=1,i=this,o=i.nearbyTruckQueue.splice(0,e);for(i.truckList.classList.add("list-unstyled");e>=n;)setTimeout(function(){t=o.shift(),i.markerDelegate.createTruckMarker(t),i.truckList&&i.addToTruckList(t)},200*n),n++},MunchiesMapView.prototype.requestNearby=function(e,t,n){var i=this;if(Date.now()-this.lastRequestTime>300){this.lastRequestTime=Date.now();var n=n||this.map.googleMap.getCenter(),o=function(){return $.get("api/v1/trucks/?lng="+n.B+"&lat="+n.k+"&dist="+e,function(e){_(e).forEach(function(e){i.map.renderedTrucks[e._id]||(i.nearbyTruckQueue.push(e),i.map.renderedTrucks[e._id]=1)})})},a=function(){i.nearbyTruckQueue.length&&i.displayNewTrucks.call(i,t)};i.map.renderedTrucks.lastRequestCoords===n?a():(o().done(a),i.map.renderedTrucks.lastRequestCoords=this.map.googleMap.getCenter())}},MunchiesMapView.prototype.renderMap=function(e,t){var n=this;this.map=new MunchiesMap(this.mapPlaceholder,e),this.markerDelegate=MunchiesMapMarkerDelegate(this.map);var i=function(){var e=0,t=["http://placekitten.com/256/256","http://placekitten.com/g/256/256","http://placekitten.com/255/255","http://placekitten.com/g/255/255","http://placekitten.com/257/257","http://placekitten.com/g/257/257"],i=new google.maps.ImageMapType({getTileUrl:function(){var o=t[e%t.length];return e++,n.pendingUrls.push(o),1===n.pendingUrls.length&&$(i).trigger("overlay-busy"),o},tileSize:new google.maps.Size(256,256),isPng:!0,opacity:0});return $(i).bind("overlay-idle",function(){}),$(i).bind("overlay-busy",function(){}),i.baseGetTile=i.getTile,i.getTile=function(e,t,o){var a=i.baseGetTile(e,t,o);return $("img",a).one("load",function(){var e=$.inArray(this.__src__,n.pendingUrls);n.pendingUrls.splice(e,1),0===n.pendingUrls.length&&$(i).trigger("overlay-idle")}),a},n.map.googleMap.overlayMapTypes.push(i),$(i)},o=i();o.on("overlay-idle",function(){null===document.getElementById("centerMarker")&&(!n.center.pinned&&n.pinCenter(t),n.dist=n.map.calculateDist(),!n.dragDelegate.inDragState&&n.requestNearby(n.dist,n.n))}),google.maps.event.addListener(n.map.googleMap,"mousedown",function(){n.dragDelegate.inDragState=!n.dragDelegate.inDragState,n.dragDelegate.dragTime=Date.now()}),google.maps.event.addListener(n.map.googleMap,"mouseup",function(){n.dragDelegate.inDragState=!n.dragDelegate.inDragState,n.dragDelegate.timeDiff=Date.now()-n.dragDelegate.dragTime,n.map.googleMap.panTo(n.map.googleMap.getCenter())}),google.maps.event.addListener(n.map.googleMap,"center_changed",function(){var e;(!n.dragDelegate.inDragState||n.dragDelegate.timeDiff>150)&&(e=n.map.googleMap.getCenter(),n.dist=n.map.calculateDist(),n.dragDelegate.dragTime=0,n.dragDelegate.timeDiff=0,n.lastCoords!==e&&(n.requestNearby(n.dist,n.n,e),n.lastCoords=e))}),google.maps.event.addListener(n.map.googleMap,"zoom_changed",function(){n.zoomLevel=n.map.googleMap.getZoom(),n.dist=n.map.calculateDist(),n.lastCoords=n.map.googleMap.getCenter(),n.requestNearby(n.dist,n.n,n.lastCoords)})},MunchiesMapView.prototype.pinCenter=function(e){var t=this,n=new google.maps.MarkerImage(e),i=this.map.googleMap.getCenter(),o=new google.maps.Marker({position:i,map:this.map.googleMap,title:"Current Location",draggable:!0,icon:n});this.center.pinned=!0,this.center.infoWindow=!1;var a=new google.maps.InfoWindow({content:'<div class="info-window">You Are Here!</div>'});google.maps.event.addListener(o,"mouseup",function(){t.map.googleMap.panTo(o.getPosition())}),google.maps.event.addListener(o,"click",function(){t.center.infoWindow?(a.close(),a.content="<div>I'm Different</div>"):a.open(t.map.googleMap,o),t.center.infoWindow=!t.center.infoWindow})};var MunchiesMap=function(e,t){this.renderedTrucks={lastRequestCoords:null},this.googleMap=new google.maps.Map(e,t)};MunchiesMap.prototype.calculateDist=function(){var e=this.googleMap.getBounds(),t=e.getCenter(),n=e.getNorthEast(),i=3963,o=t.lat()/57.2958,a=t.lng()/57.2958,s=n.lat()/57.2958,r=n.lng()/57.2958,d=i*Math.acos(Math.sin(o)*Math.sin(s)+Math.cos(o)*Math.cos(s)*Math.cos(r-a));return d/1.5};var MunchiesMapDragDelegate=function(){this.dragTime=0,this.timeDiff=0,this.inDragState=!1},MunchiesListView=function(){this.truckList=document.getElementById("truckList")};MunchiesListView.prototype.addToTruckList=function(e){if(this.truckList&&e){var t=document.createElement("tr"),n=document.createElement("td"),i=document.createElement("td"),o=e.applicant.split(/(dba. )|(DBA )|(DBA: )/);n.innerText=o[o.length-1],i.innerText=e.locationdescription,t.classList.add("truckRow"),n.classList.add("truckName"),i.classList.add("truckAddress"),t.appendChild(n),t.appendChild(i),this.truckList.appendChild(t)}},MunchiesMapView.prototype.addToTruckList=MunchiesListView.prototype.addToTruckList.bind(this),MunchiesMapMarkerDelegateMethods={},MunchiesMapMarkerDelegateMethods.compileInfoWindow=function(e){if(e){var t="";_(e.fooditems.split(": ")).forEach(function(e){t+="<li>"+e.trim()+"</li>"});var n='<div class="info-window" data-truck-id="'+e._id+'"><div><div style="font-weight: 700">'+e.applicant+"</div><ul>"+t+"</ul></div></div>";return n}},MunchiesMapMarkerDelegateMethods.createInfoWindow=function(e){if(e){var t=this,n=this.compileInfoWindow(e),i=new google.maps.InfoWindow({content:n});google.maps.event.addListener(i,"closeclick",function(){t.infoWindows.trucks[e._id]&&t.infoWindows.trucks[e._id].isOpen&&t.closeInfoWindow(e._id)}),t.infoWindows.trucks[e._id]=i}},MunchiesMapMarkerDelegateMethods.closeInfoWindow=function(e){this.infoWindows.trucks[e].close(),this.infoWindows.count--,this.infoWindows.trucks[e].isOpen=!1,this.map.googleMap.panTo(this.lastCoords)},MunchiesMapMarkerDelegateMethods.createTruckMarker=function(e){if(e){var t=this,n=new google.maps.LatLng(e.latitude,e.longitude),i=new google.maps.Marker({position:n,map:this.map.googleMap,animation:google.maps.Animation.DROP,title:e.applicant});t.map.renderedTrucks[e._id]=1,google.maps.event.addListener(i,"click",function(){var n=_(document.getElementsByClassName("info-window"));t.lastCoords=t.map.googleMap.getCenter(),t.infoWindows.trucks[e._id].open(t.map.googleMap,i),t.infoWindows.trucks[e._id].isOpen=!0,t.infoWindows.count++,n.forEach(function(n){n.getAttribute("data-truck-id")===e._id&&n.addEventListener("click",function(){t.infoWindows.trucks[e._id]&&t.infoWindows.trucks[e._id].isOpen&&t.closeInfoWindow(e._id)})}),setTimeout(function(){t.infoWindows.trucks[e._id].isOpen&&t.closeInfoWindow(e._id)},3500)}),t.createInfoWindow(e)}};var MunchiesMapMarkerDelegate=function(e){var t={};return t.map=e,t.infoWindows={count:0,trucks:{}},_(t).extend(MunchiesMapMarkerDelegateMethods,null,t),t};